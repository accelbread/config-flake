#!/usr/bin/env nix-shell
#!nix-shell -i bash --pure -p coreutils nix git gnutar
set -euo pipefail

if [ -f flake.nix ]; then
  TREE=$(mktemp -d)
  trap 'rm -rf -- "$TREE"' EXIT
  cp -r .git "$TREE/"
  cd "$TREE"
  rm -f .git/index.lock || true
  git restore .
  rm -rf .git
  nix flake check "$TREE"
fi
